---
apiVersion: v1
kind: Secret
metadata:
  name: openclaw-cloudinit
type: Opaque
stringData:
  userdata: |
    #cloud-config
    package_update: true
    packages:
      - curl
      - qemu-guest-agent

    users:
      - name: openclaw
        shell: /bin/bash
        sudo: ALL=(ALL) NOPASSWD:ALL
        lock_passwd: true
        ssh_authorized_keys:
          - ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPpImAuOJLlSWirZ4ZZVny3rycrioOJedfEx8I2BRRRD leonard@suslian.engineer

    runcmd:
      # Enable qemu-guest-agent
      - systemctl enable --now qemu-guest-agent

      # Install Node.js 22.x
      - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      - apt-get install -y nodejs

      # Install OpenClaw
      - npm install -g openclaw@latest

      # Configure gateway to trust Cilium envoy proxy
      - mkdir -p /home/openclaw/.openclaw
      - echo '{"gateway":{"trustedProxies":["10.244.0.0/16"]}}' > /home/openclaw/.openclaw/openclaw.json
      - chown -R openclaw:openclaw /home/openclaw/.openclaw

      # Create systemd service
      - |
        cat <<'EOF' > /etc/systemd/system/openclaw.service
        [Unit]
        Description=OpenClaw AI Assistant
        After=network-online.target
        Wants=network-online.target

        [Service]
        Type=simple
        User=openclaw
        ExecStart=/usr/bin/openclaw gateway --port 18789 --bind lan --allow-unconfigured --auth password --password openclaw
        Restart=on-failure
        RestartSec=5

        [Install]
        WantedBy=multi-user.target
        EOF
      - systemctl daemon-reload
      - systemctl enable --now openclaw.service
